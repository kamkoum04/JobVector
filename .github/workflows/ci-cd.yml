name: JobVector CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Java 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: Build Backend
        working-directory: backend
        run: ./mvnw clean package -DskipTests

      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: backend/target/*.jar
          retention-days: 1

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Build Frontend
        working-directory: frontend
        run: |
          npm ci --legacy-peer-deps
          npm run build

      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: |
            frontend/.next/standalone
            frontend/.next/static
            frontend/public
          retention-days: 1

  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Java 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: Test Backend
        working-directory: backend
        run: ./mvnw test

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Frontend Dependencies
        working-directory: frontend
        run: npm ci --legacy-peer-deps

      - name: Test Frontend
        working-directory: frontend
        run: npm test

  push:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Backend
        run: |
          IMAGE_TAG=${{ github.sha }}
          docker build -t ${{ secrets.DOCKER_USERNAME }}/jobvector-backend:${IMAGE_TAG} \
                       -t ${{ secrets.DOCKER_USERNAME }}/jobvector-backend:latest ./backend
          docker push ${{ secrets.DOCKER_USERNAME }}/jobvector-backend:${IMAGE_TAG}
          docker push ${{ secrets.DOCKER_USERNAME }}/jobvector-backend:latest

      - name: Build and Push Frontend
        run: |
          IMAGE_TAG=${{ github.sha }}
          docker build -t ${{ secrets.DOCKER_USERNAME }}/jobvector-frontend:${IMAGE_TAG} \
                       -t ${{ secrets.DOCKER_USERNAME }}/jobvector-frontend:latest ./frontend
          docker push ${{ secrets.DOCKER_USERNAME }}/jobvector-frontend:${IMAGE_TAG}
          docker push ${{ secrets.DOCKER_USERNAME }}/jobvector-frontend:latest

      # - name: Build and Push Embedding Service
      #   run: |
      #     docker build -t ${{ secrets.DOCKER_USERNAME }}/jobvector-embeddingservice:latest ./embeddingService
      #     docker push ${{ secrets.DOCKER_USERNAME }}/jobvector-embeddingservice:latest

  deploy:
    name: Deploy to AWS EKS
    runs-on: ubuntu-latest
    needs: push
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig \
            --region ${{ secrets.AWS_REGION }} \
            --name job-vector-cluster

      - name: Verify cluster connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Create/Update Namespace
        run: |
          kubectl apply -f kubernetes/namespace/namespace.yaml

      - name: Create/Update Backend ConfigMap
        run: |
          kubectl apply -f kubernetes/backend/configmap.yaml

      - name: Create/Update Frontend ConfigMap
        run: |
          kubectl apply -f kubernetes/frontend/configmap.yaml

      - name: Create/Update Backend Secret from GitHub Secrets
        run: |
          kubectl create secret generic backend-secret \
            --from-literal=DB_PASSWORD='${{ secrets.DB_PASSWORD }}' \
            --from-literal=JWT_SECRET='${{ secrets.JWT_SECRET }}' \
            --from-literal=JWT_EXPIRATION='${{ secrets.JWT_EXPIRATION }}' \
            --namespace=jobvector \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Create/Update PVCs
        run: |
          kubectl apply -f kubernetes/backend/pvc.yaml

      - name: Deploy Ollama StatefulSet
        run: |
          kubectl apply -f kubernetes/ollama/statefulset.yaml
          kubectl apply -f kubernetes/ollama/service.yaml

      - name: Deploy Embedding Service
        run: |
          kubectl apply -f kubernetes/embedding-service/deployment.yaml
          kubectl apply -f kubernetes/embedding-service/service.yaml

      - name: Wait for Ollama to be ready
        run: |
          kubectl wait --for=condition=ready pod -l app=ollama \
            --namespace=jobvector --timeout=300s || true

      - name: Wait for Embedding Service to be ready
        run: |
          kubectl wait --for=condition=ready pod -l app=embeddingservice \
            --namespace=jobvector --timeout=180s || true

      - name: Deploy Backend
        run: |
          kubectl apply -f kubernetes/backend/deployment.yaml
          kubectl apply -f kubernetes/backend/service.yaml

      - name: Update Backend Image (force new deployment)
        run: |
          kubectl set image deployment/backend backend=${{ secrets.DOCKER_USERNAME }}/jobvector-backend:${{ github.sha }} -n jobvector
          kubectl rollout status deployment/backend -n jobvector --timeout=600s || true
          echo "Waiting for backend pods to be ready..."
          kubectl wait --for=condition=ready pod -l app=backend -n jobvector --timeout=600s || echo "Backend pods may need more time"

      - name: Deploy Frontend
        run: |
          kubectl apply -f kubernetes/frontend/deployment.yaml
          kubectl apply -f kubernetes/frontend/service.yaml

      - name: Update Frontend Image (force new deployment)
        run: |
          kubectl set image deployment/frontend frontend=${{ secrets.DOCKER_USERNAME }}/jobvector-frontend:${{ github.sha }} -n jobvector
          kubectl rollout status deployment/frontend -n jobvector --timeout=300s || true
          echo "Waiting for frontend pods to be ready..."
          kubectl wait --for=condition=ready pod -l app=frontend -n jobvector --timeout=300s || echo "Frontend pods may need more time"

      - name: Verify Deployment
        run: |
          echo "=== Pods Status ==="
          kubectl get pods -n jobvector
          echo ""
          echo "=== Services ==="
          kubectl get svc -n jobvector
          echo ""
          echo "=== Deployment Status ==="
          kubectl get deployments -n jobvector

      - name: Get Nginx IP and Test Health
        run: |
          NGINX_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=jobvector-nginx" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          echo "Nginx Proxy IP: $NGINX_IP"
          echo "Testing backend health endpoint..."
          sleep 10
          curl -f http://$NGINX_IP/api/actuator/health || echo "Health check failed (may need more time)"

      - name: Show Backend Logs (last 50 lines)
        if: always()
        run: |
          kubectl logs -l app=backend -n jobvector --tail=50 || echo "Could not retrieve backend logs"

      - name: ğŸ‰ Deployment Summary - Access URLs
        if: success()
        run: |
          NGINX_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=jobvector-nginx" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          ğŸš€ JobVector Application Deployed Successfully!         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“± Access Your Application:"
          echo "â”œâ”€ ğŸŒ Frontend:        http://$NGINX_IP"
          echo "â”œâ”€ ğŸ”§ Backend API:     http://$NGINX_IP/api"
          echo "â”œâ”€ ğŸ’š Health Check:    http://$NGINX_IP/api/actuator/health"
          echo "â””â”€ ğŸ“Š Actuator Info:   http://$NGINX_IP/api/actuator/info"
          echo ""
          echo "ğŸ” Default Admin Credentials:"
          echo "â”œâ”€ Email:    admin@jobvector.tn"
          echo "â””â”€ Password: Admin@123"
          echo ""
          echo "ğŸ¯ API Endpoints Examples:"
          echo "â”œâ”€ Job Offers:         http://$NGINX_IP/api/job-offers"
          echo "â”œâ”€ Applications:       http://$NGINX_IP/api/applications"
          echo "â””â”€ Authentication:     http://$NGINX_IP/api/auth/login"
          echo ""
          echo "ğŸ“¦ Deployed Services:"
          kubectl get pods -n jobvector -o custom-columns='NAME:.metadata.name,STATUS:.status.phase,NODE:.spec.nodeName'
          echo ""
          echo "ğŸ”— Quick Links:"
          echo "â”œâ”€ GitHub Repo:        https://github.com/${{ github.repository }}"
          echo "â”œâ”€ Commit SHA:         ${{ github.sha }}"
          echo "â””â”€ Deployed By:        ${{ github.actor }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
